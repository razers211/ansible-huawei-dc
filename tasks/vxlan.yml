---
- name: Enable VXLAN on leaf switches
  ansible.netcommon.cli_config:
    lines:
      - vxlan

- name: Configure NVE interface
  ansible.netcommon.cli_config:
    lines:
      - interface Nve1
      - source {{ vtep_loopback.split('/')[0] }}
      - description VTEP for VXLAN
      - undo shutdown
      - quit
  when: vtep_loopback is defined

- name: Configure bridge domain for VXLAN
  ansible.netcommon.cli_config:
    lines:
      - bridge-domain {{ item }}
      - vxlan vni {{ item }}
      - quit
  loop: "{{ vni_range.split('-')[0] | int + range(0, 100) | list }}"
  when: vni_range is defined

- name: Configure VLAN to VNI mapping
  ansible.netcommon.cli_config:
    lines:
      - bridge-domain {{ item }}
      - vxlan vni {{ item }}
      - quit
      - interface Vlanif{{ item | int + 1000 }}
      - vxlan vni {{ item }}
      - quit
  loop: "{{ vni_range.split('-')[0] | int + range(0, 100) | list }}"
  when: vni_range is defined

- name: Configure EVPN for VXLAN
  ansible.netcommon.cli_config:
    lines:
      - bgp {{ asn }}
      - l2vpn evpn
      - advertise irb
      - advertise l2vpn evpn
      - quit
      - quit

- name: Configure ARP suppression
  ansible.netcommon.cli_config:
    lines:
      - interface Nve1
      - arp-suppress enable
      - quit
  when: vtep_loopback is defined

- name: Configure MAC learning limit
  ansible.netcommon.cli_config:
    lines:
      - interface Nve1
      - mac-limit maximum 65536
      - quit
  when: vtep_loopback is defined
