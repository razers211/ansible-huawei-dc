========================================
FABRIC HEALTH VERIFICATION REPORT
========================================

Verification Date: {{ ansible_date_time.iso8601 }}

SUMMARY:
Total Devices: {{ all_results | length }}
Spine Switches: {{ all_results | selectattr('type', 'equalto', 'spine') | list | length }}
Leaf Switches: {{ all_results | selectattr('type', 'equalto', 'leaf') | list | length }}

DEVICE DETAILS:
{% for device in all_results %}
{{ device.hostname }} ({{ device.type | upper }}):
  Interfaces: {{ device.interfaces_up }}/{{ device.interfaces_total }} up
  OSPF Neighbors: {{ device.ospf_neighbors }}
  BGP Peers: {{ device.bgp_peers }}
  {% if device.interfaces_up == device.interfaces_total %}
  ✅ Interface Status: HEALTHY
  {% else %}
  ❌ Interface Status: {{ device.interfaces_total - device.interfaces_up }} interfaces down
  {% endif %}
  
  {% if device.ospf_neighbors > 0 %}
  ✅ OSPF Status: HEALTHY
  {% else %}
  ❌ OSPF Status: NO NEIGHBORS
  {% endif %}
  
  {% if device.bgp_peers > 0 %}
  ✅ BGP Status: HEALTHY
  {% else %}
  ❌ BGP Status: NO PEERS
  {% endif %}

{% endfor %}

HEALTH CHECKS:
{% set total_interfaces = all_results | sum(attribute='interfaces_total') %}
{% set up_interfaces = all_results | sum(attribute='interfaces_up') %}
Interface Health: {{ (up_interfaces / total_interfaces * 100) | round(1) }}% ({{ up_interfaces }}/{{ total_interfaces }})

{% set total_ospf = all_results | sum(attribute='ospf_neighbors') %}
{% set expected_ospf = (all_results | length * 2) %}
OSPF Health: {{ (total_ospf / expected_ospf * 100) | round(1) }}% ({{ total_ospf }}/{{ expected_ospf }} neighbors)

{% set total_bgp = all_results | sum(attribute='bgp_peers') %}
{% set expected_bgp = (all_results | selectattr('type', 'equalto', 'spine') | list | length * (all_results | selectattr('type', 'equalto', 'leaf') | list | length) + (all_results | selectattr('type', 'equalto', 'leaf') | list | length * (all_results | selectattr('type', 'equalto', 'spine') | list | length)) %}
BGP Health: {{ (total_bgp / expected_bgp * 100) | round(1) }}% ({{ total_bgp }}/{{ expected_bgp }} peers)

RECOMMENDATIONS:
{% for device in all_results %}
{% if device.interfaces_up < device.interfaces_total %}
- Check down interfaces on {{ device.hostname }}
{% endif %}
{% if device.ospf_neighbors == 0 %}
- Verify OSPF configuration on {{ device.hostname }}
{% endif %}
{% if device.bgp_peers == 0 %}
- Check BGP peer configuration on {{ device.hostname }}
{% endif %}
{% endfor %}

NEXT STEPS:
1. Investigate any failed health checks
2. Run individual device verification if needed
3. Check logs for detailed error information
4. Verify traffic flow between leaf switches
5. Test tenant network connectivity

TROUBLESHOOTING COMMANDS:
- Interface issues: display interface <interface-name>
- OSPF problems: display ospf peer verbose
- BGP issues: display bgp peer verbose
- VXLAN problems: display vxlan tunnel verbose

========================================
Report generated by Ansible Fabric Manager
========================================
